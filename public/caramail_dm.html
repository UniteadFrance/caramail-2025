<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Discussion privée — 3615celib</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#e9e9e9;color:#111}
    header{background:linear-gradient(#d7d7d7,#c9c9c9);border-bottom:1px solid #9c9c9c;padding:10px 14px}
    .ttl{font-weight:700;font-size:18px}
    .wrap{max-width:980px;margin:12px auto;padding:0 12px}
    .panel{background:#fff;border:1px solid #d0d0d0;border-radius:8px;overflow:hidden}
    .panel-bd{height:60vh;min-height:380px;overflow:auto;padding:12px;background:#fafafa}
    .msg{margin:6px 0}
    .from{font-weight:700;color:#114a9c}
    .me{color:#177a3a}
    .sys{color:#777;font-size:12px}
    footer{display:flex;gap:8px;padding:10px;background:#f5f5f5;border-top:1px solid #ddd}
    input,select,button{height:40px;font-size:16px}
    input[type="text"]{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
    button{background:#2267e6;color:#fff;border:1px solid #1e56bf;border-radius:6px;padding:0 14px;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .label{font-size:12px;color:#555}
  </style>
</head>
<body>
  <header><div class="ttl">Discussion privée</div></header>
  <div class="wrap">
    <div class="panel">
      <div class="row" style="padding:10px">
        <div class="label">Moi :</div>
        <input id="me" type="text" value="" style="max-width:220px" />
        <div class="label">Avec :</div>
        <input id="peer" type="text" value="" style="max-width:220px" />
        <button id="btnJoin">Rejoindre</button>
      </div>
      <div id="log" class="panel-bd"></div>
      <footer>
        <input id="msg" type="text" placeholder="Écris ton message…" />
        <button id="send">Envoyer</button>
      </footer>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Utilitaires
    function qs(k){return new URLSearchParams(location.search).get(k)}
    function esc(s){return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}
    function el(t,cls,html){const e=document.createElement(t); if(cls)e.className=cls; e.innerHTML=html||''; return e}
    function scrollBottom(){ logEl.scrollTop = logEl.scrollHeight }

    // Elements
    const meEl = document.getElementById('me');
    const peerEl = document.getElementById('peer');
    const logEl = document.getElementById('log');
    const msgEl = document.getElementById('msg');
    const btnJoin = document.getElementById('btnJoin');
    const btnSend = document.getElementById('send');

    // Nick local (simple : localStorage)
    const savedNick = localStorage.getItem('nick') || '';
    meEl.value = savedNick || `invité-${Math.random().toString(36).slice(2,6)}`;
    peerEl.value = qs('peer') || peerEl.value;

    // Connexion socket avec mon pseudo
    const socket = io({ query: { nick: meEl.value } });

    // Re-emit présence optionnel (améliore l’affichage ailleurs)
    socket.emit('presence:update', { nick: meEl.value, color: 'blue', room: '@' + (peerEl.value || '') });

    // Rejoindre la room DM
    function joinDM(){
      const me = meEl.value.trim(); const peer = peerEl.value.trim();
      if(!me || !peer){ alert('Renseigne ton pseudo et celui de ton interlocuteur.'); return; }
      localStorage.setItem('nick', me);
      socket.emit('dm:join', { peer });
      logEl.append(el('div','sys',`<em>Discussion avec <strong>${esc(peer)}</strong>…</em>`));
      scrollBottom();
    }

    // Envoi
    function send(){
      const me = meEl.value.trim(); const peer = peerEl.value.trim();
      const tx = msgEl.value.trim(); if(!tx) return;
      socket.emit('dm:send', { peer, text: tx });
      logEl.append(el('div','msg', `<span class="from me">${esc(me)}</span> &gt; ${esc(tx)}`));
      msgEl.value=''; scrollBottom();
    }

    // Réception
    socket.on('dm:msg', ({ from, text }) => {
      logEl.append(el('div','msg', `<span class="from">${esc(from)}</span> &gt; ${esc(text)}`));
      scrollBottom();
    });
    socket.on('dm:info', ({ who, type }) => {
      const action = type==='join' ? 'rejoint' : 'quitté';
      logEl.append(el('div','sys', `<em>${esc(who)} a ${action} la discussion</em>`));
      scrollBottom();
    });

    // UI
    btnJoin.addEventListener('click', joinDM);
    btnSend.addEventListener('click', send);
    msgEl.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

    // Auto-join si l’URL contient ?peer=...
    if (peerEl.value) joinDM();
  </script>
</body>
</html>
