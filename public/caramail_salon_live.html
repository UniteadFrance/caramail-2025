<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>CaraMail — Salon (temps réel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#e6e6e6;color:#111}
    a{color:#0047cc;text-decoration:underline}
    .wrap{min-height:100vh;display:flex;flex-direction:column}
    .topbar{background:#cfcfcf;border-bottom:1px solid #9c9c9c;display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;padding:6px 10px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;position:relative}
    .tabs:after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:#b5b5b5}
    .tab{background:#e9e9e9;padding:6px 10px;border-top:1px solid #fff;border-left:1px solid #fff;border-right:1px solid #8f8f8f;border-bottom:1px solid #8f8f8f;border-radius:4px 4px 0 0;font-weight:700;white-space:nowrap}
    .tab.active{background:#fff;border-bottom-color:#fff}
    .tab.active .tab-label{color:#0047cc;text-decoration:underline}
    .status{margin-left:auto;padding-bottom:6px;font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:50%}
    .main{flex:1;display:flex;gap:10px;padding:12px}
    .rightcol{width:240px;display:flex;flex-direction:column;gap:10px}
    .box{background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;padding:10px}
    .members .member{padding:4px 6px;border-bottom:1px dashed #ededed}
    .chat-panel{flex:1;background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;display:flex;flex-direction:column;min-width:0}
    .header-chat{background:linear-gradient(#efefef,#e6e6e6);padding:10px;border-bottom:1px solid #d0d0d0;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .room{font-weight:bold;color:#0b4a7a}
    .dialogue{flex:1;padding:10px;background:#fff;overflow:auto}
    .message{margin:6px 0;line-height:1.45;font-size:14px}
    .sys{color:#8a8a8a;font-style:italic}
    .msg-pseudo{font-weight:bold;margin-right:6px}
    .pseudo-blue{color:#0044cc}.pseudo-red{color:#cc0000}.pseudo-yellow{color:#b8860b}.pseudo-green{color:#1e7d3b}
    .input-area{padding:8px;border-top:1px solid #dcdcdc;background:linear-gradient(#f6f6f6,#ececec);display:flex;gap:8px;align-items:center}
    .nick{width:140px;padding:8px;border:1px solid #cfcfcf;border-radius:6px}
    .txt{flex:1;padding:8px;border:1px solid #cfcfcf;border-radius:6px}
    .send{padding:8px 12px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
    @media(max-width:820px){.main{flex-direction:column}.rightcol{width:100%}}
  </style>

<!-- Mobile height + scroll fix -->
<style>
  /* 1) Use dynamic viewport units on mobile */
  .wrap{ height:100vh; } /* fallback */
  @supports (height: 100dvh){
    .wrap{ height:100dvh; }
  }

  /* 2) Flex layout so only chat area scrolls */
  .wrap{ display:flex; flex-direction:column; }
  .main{ flex:1; min-height:0; }
  .chat-panel{ flex:1; display:flex; flex-direction:column; min-height:0; }
  .dialogue{ flex:1; overflow-y:auto; min-height:0; }

  /* 3) Stop body from scrolling behind */
  html,body{ height:100%; overflow:hidden; }
</style>
<script>
  // 4) Extra safety for iOS Safari: set a CSS var based on innerHeight
  (function(){
    function setVH(){
      document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
    }
    setVH();
    window.addEventListener('resize', setVH);
  })();
</script>
<style>
  /* Use the JS var as a last-resort fallback if needed */
  .wrap{ height: calc(var(--vh, 1vh) * 100); }
</style>

</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="tabs" aria-label="Onglets">
        <div class="tab active"><span class="tab-label">Salon</span></div>
        <div class="tab"><span class="tab-label">Connecté(e)s</span></div>
        <div class="tab"><span class="tab-label">Options</span></div>
        <div class="tab"><span class="tab-label">Ami(e)s</span></div>
        <div class="tab"><span class="tab-label">Mon compte</span></div>
      </div>
      <div class="status">Connecté en tant que <strong id="meLabel">invité</strong></div>
    </div>

    <main class="main">
      <aside class="rightcol">
        <div class="box">
          <h4>Membres (démo)</h4>
          <div id="roster" class="members"></div>
        </div>
        <div class="box">
          <h4>Options rapides</h4>
          <label>Couleur pseudo
            <select id="color">
              <option value="blue">Bleu</option>
              <option value="red">Rouge</option>
              <option value="yellow">Jaune</option>
              <option value="green">Vert</option>
            </select>
          </label>
        </div>
      </aside>

      <section class="chat-panel">
        <div class="header-chat">
          <div class="room" id="roomTitle">#cafe-des-modes</div>
          <div class="topic">Bienvenue — temps réel</div>
        </div>
        <div id="dialogue" class="dialogue" aria-live="polite"></div>
        <form id="form" class="input-area">
          <input id="nick" class="nick" placeholder="Pseudo" value="invité" required>
          <input id="text" class="txt" placeholder="Écris ton message..." autocomplete="off">
          <button class="send" type="submit">Envoyer</button>
        </form>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- Récupération robuste de nick/room (query string ET hash) ---
    function getInitialParams(){
      const searchParams = new URLSearchParams(location.search);
      let nick = searchParams.get('nick');
      let room = searchParams.get('room');

      // Si le # d'un room a "coupé" l'URL, la suite est dans location.hash
      const hash = (location.hash || '').replace(/^#/, '');
      if(hash){
        // Cas 1: hash contient une query "nick=...&room=..." -> on la lit
        const hp = new URLSearchParams(hash);
        nick = nick || hp.get('nick');
        room = room || hp.get('room');

        // Cas 2: hash ressemble à "nostalgie-2002&nick=Steph" -> on récupère la 1ère partie comme room
        if(!room){
          const firstPart = hash.split('&')[0];
          if(firstPart) room = '#' + decodeURIComponent(firstPart.replace(/^%23/, ''));
        }
      }
      // Valeurs par défaut
      return {
        nick: (nick || 'invité').slice(0, 32),
        room: room || '#cafe-des-modes'
      };
    }

    const init = getInitialParams();

    // --- Éléments ---
    const dlg = document.getElementById('dialogue');
    const form = document.getElementById('form');
    const text = document.getElementById('text');
    const nickInput = document.getElementById('nick');
    const colorSel = document.getElementById('color');
    const meLabel = document.getElementById('meLabel');
    const roster = document.getElementById('roster');
    const roomTitle = document.getElementById('roomTitle');

    // --- Init UI ---
    nickInput.value = init.nick;
    meLabel.textContent = init.nick;
    roomTitle.textContent = init.room;

    const socket = io();
    let lastSent = null;

    function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    function line(type,pseudo,content,color){
      const div=document.createElement('div');
      div.className='message '+(type==='sys'?'sys':'');
      if(type==='sys'){div.textContent='— '+content;}
      else{div.innerHTML='<span class="msg-pseudo pseudo-'+(color||'blue')+'">'+escapeHtml(pseudo)+'&gt;</span> '+escapeHtml(content);}
      dlg.appendChild(div); dlg.scrollTop=dlg.scrollHeight;
    }

    function renderRoster(){
      const pseudo = nickInput.value || 'invité';
      roster.innerHTML = ['caranormandie','mike-caen','guest_42', pseudo].map(u=>'<div class="member">'+escapeHtml(u)+'</div>').join('');
    }
    renderRoster();
    nickInput.addEventListener('input', ()=>{ meLabel.textContent = nickInput.value||'invité'; renderRoster(); });

    form.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt = text.value.trim(); if(!txt) return;
      const pseudo = nickInput.value || 'invité';
      const payload = pseudo + ': ' + txt;
      lastSent = payload;
      line('msg', pseudo, txt, colorSel.value);
      socket.emit('chat message', payload);
      text.value='';
    });

    socket.on('chat message',(msg)=>{
      if(lastSent && msg===lastSent){ lastSent=null; return; }
      const m = String(msg).split(':',2);
      const pseudo = m[0] || 'autre';
      const content = msg.slice((pseudo+':').length).trim();
      line('msg', pseudo, content, 'red');
    });

    line('sys','', 'Connecté(e) en tant que '+init.nick+' • Salon: '+init.room+'. Ouvre cette page dans un 2ᵉ onglet pour tester.');
  </script>

  <script src="/caramail_nav.js"></script>
</body>
</html>
