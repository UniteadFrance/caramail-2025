<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>CaraMail — Salon (temps réel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;overflow:hidden;font-family:Arial,Helvetica,sans-serif;background:#e6e6e6;color:#111}
    a{color:#0047cc;text-decoration:underline}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    /* Top tabs */
    .topbar{background:#cfcfcf;border-bottom:1px solid #9c9c9c;display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;padding:6px 10px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;position:relative}
    .tabs:after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:#b5b5b5}
    .tab{background:#e9e9e9;padding:6px 10px;border-top:1px solid #fff;border-left:1px solid #fff;border-right:1px solid #8f8f8f;border-bottom:1px solid #8f8f8f;border-radius:4px 4px 0 0;font-weight:700;white-space:nowrap}
    .tab.active{background:#fff;border-bottom-color:#fff}
    .tab.active .tab-label{color:#0047cc;text-decoration:underline}
    .status{margin-left:auto;padding-bottom:6px;font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:50%}
    /* Layout */
    .main{flex:1;display:flex;gap:10px;padding:12px;min-height:0}
    .rightcol{width:240px;display:flex;flex-direction:column;gap:10px;min-width:220px}
    .box{background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;padding:10px}
    .members .member{padding:4px 6px;border-bottom:1px dashed #ededed}
    .chat-panel{flex:1;background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;display:flex;flex-direction:column;min-height:0}
    .header-chat{background:linear-gradient(#efefef,#e6e6e6);padding:10px;border-bottom:1px solid #d0d0d0;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .room{font-weight:bold;color:#0b4a7a}
    .dialogue{flex:1;padding:10px;background:#fff;overflow-y:auto;min-height:0}
    .message{margin:6px 0;line-height:1.45;font-size:14px}
    .sys{color:#8a8a8a;font-style:italic}
    .msg-pseudo{font-weight:bold;margin-right:6px}
    .pseudo-blue{color:#0044cc}.pseudo-red{color:#cc0000}.pseudo-yellow{color:#b8860b}.pseudo-green{color:#1e7d3b}
    .input-area{padding:8px;border-top:1px solid #dcdcdc;background:linear-gradient(#f6f6f6,#ececec);display:flex;gap:8px;align-items:center}
    .nick{width:140px;padding:8px;border:1px solid #cfcfcf;border-radius:6px}
    .txt{flex:1;padding:8px;border:1px solid #cfcfcf;border-radius:6px}
    .send{padding:8px 12px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
    /* Mobile tweaks */
    .mobile-color{display:none}
    @media(max-width:820px){
      .rightcol{display:none}                 /* cache la colonne droite en mobile */
      .mobile-color{display:inline-block}     /* montre le sélecteur couleur compact */
      .nick{width:110px}
      .input-area{gap:6px}
      .status{max-width:40%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="tabs" aria-label="Onglets">
        <div class="tab active"><span class="tab-label">Salon</span></div>
        <div class="tab"><span class="tab-label">Connecté(e)s</span></div>
        <div class="tab"><span class="tab-label">Options</span></div>
        <div class="tab"><span class="tab-label">Ami(e)s</span></div>
        <div class="tab"><span class="tab-label">Mon compte</span></div>
      </div>
      <div class="status">Connecté en tant que <strong id="meLabel">invitéxy</strong></div>
    </div>

    <main class="main">
      <aside class="rightcol">
        <div class="box">
          <h4>Membres (démo)</h4>
          <div id="roster" class="members"></div>
        </div>
        <div class="box desktop-color">
          <h4>Options rapides</h4>
          <label>Couleur pseudo
            <select id="color">
              <option value="blue">Bleu</option>
              <option value="red">Rouge</option>
              <option value="yellow">Jaune</option>
              <option value="green">Vert</option>
            </select>
          </label>
        </div>
      </aside>

      <section class="chat-panel">
        <div class="header-chat">
          <div class="room" id="roomTitle">#cafe-des-modes</div>
          <div class="topic">Bienvenue — temps réel</div>
        </div>

        <div id="dialogue" class="dialogue" aria-live="polite"></div>

        <form id="form" class="input-area">
          <input id="nick" class="nick" placeholder="Pseudo" value="invitéxy" required>
          <!-- Sélecteur couleur compact visible en mobile -->
          <select id="colorMobile" class="mobile-color" aria-label="Couleur du pseudo (mobile)">
            <option value="blue">Bleu</option>
            <option value="red">Rouge</option>
            <option value="yellow">Jaune</option>
            <option value="green">Vert</option>
          </select>
          <input id="text" class="txt" placeholder="Écris ton message..." autocomplete="off">
          <button class="send" type="submit">Envoyer</button>
        </form>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- Lire les paramètres ?nick= & ?room= depuis l'URL ---
    const params = new URLSearchParams(location.search);
    const initialNick = (params.get('nick') || 'invitéxy').slice(0, 32);
    const initialRoom = params.get('room') || '#cafe-des-modes';

    // --- Récup des éléments ---
    const dlg = document.getElementById('dialogue');
    const form = document.getElementById('form');
    const text = document.getElementById('text');
    const nick = document.getElementById('nick');
    const colorSel = document.getElementById('color');            // desktop (si présent)
    const colorMobile = document.getElementById('colorMobile');   // mobile compact
    const meLabel = document.getElementById('meLabel');
    const roster = document.getElementById('roster');
    const roomTitle = document.getElementById('roomTitle');

    // --- Init UI ---
    nick.value = initialNick;
    meLabel.textContent = initialNick;
    roomTitle.textContent = initialRoom;

    // Sync couleur entre desktop et mobile
    function syncColor(from){
      const val = from.value;
      if(colorSel) colorSel.value = val;
      if(colorMobile) colorMobile.value = val;
    }
    if(colorSel) colorSel.addEventListener('change', e => syncColor(e.target));
    if(colorMobile) colorMobile.addEventListener('change', e => syncColor(e.target));
    // Valeur initiale
    if(colorSel && colorMobile){ colorMobile.value = colorSel.value; }

    // --- Socket.IO ---
    const socket = io();
    let lastSent = null;

    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function line(type, pseudo, content, color){
      const div = document.createElement('div');
      div.className = 'message ' + (type==='sys'?'sys':'');
      if(type==='sys'){
        div.textContent = '— ' + content;
      }else{
        div.innerHTML = '<span class="msg-pseudo pseudo-' + (color||'blue') + '">' + escapeHtml(pseudo) + '&gt;</span> ' + escapeHtml(content);
      }
      dlg.appendChild(div);
      dlg.scrollTop = dlg.scrollHeight;
    }

    function updateMe(){
      meLabel.textContent = nick.value || 'invitéxy';
      renderRoster();
    }
    nick.addEventListener('input', updateMe);

    function renderRoster(){
      const pseudo = nick.value || 'invitéxy';
      if(!roster) return;
      roster.innerHTML = ['caranormandie','mike-caen','guest_42', pseudo]
        .map(u => '<div class="member">'+escapeHtml(u)+'</div>').join('');
    }
    renderRoster();

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const txt = text.value.trim();
      if(!txt) return;
      const pseudo = nick.value || 'invitéxy';
      const color = (colorSel && colorSel.value) || (colorMobile && colorMobile.value) || 'blue';
      const payload = pseudo + ': ' + txt;
      lastSent = payload;
      line('msg', pseudo, txt, color);
      socket.emit('chat message', payload);
      text.value='';
    });

    socket.on('chat message', (msg) => {
      if(lastSent && msg === lastSent){ lastSent = null; return; }
      const m = String(msg).split(':', 2);
      const pseudo = m[0] || 'autre';
      const content = msg.slice((pseudo+':').length).trim();
      line('msg', pseudo, content, 'red');
    });

    line('sys', '', 'Connecté(e) en tant que ' + initialNick + ' • Salon: ' + initialRoom + '.');
  </script>

  <!-- Soudure des onglets si présent -->
  <script src="/caramail_nav.js"></script>
</body>
</html>
