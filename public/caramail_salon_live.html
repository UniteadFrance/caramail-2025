<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CaraMail — Salon (lockdown fixe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin: 0; height: 100%;
      overflow: hidden !important;           /* aucun scroll global */
      overscroll-behavior: none;
      touch-action: none;                    /* on réactive au besoin par composant */
      font-family: Arial, Helvetica, sans-serif;
      background: #e6e6e6; color: #111;
    }

    :root{
      --appH: 100svh;        /* mis à jour via VisualViewport */
      --inputH: 64px;        /* mis à jour via ResizeObserver */
    }

    #app{
      position: fixed; inset: 0;
      height: var(--appH);
      display: flex; flex-direction: column;
    }

    /* Barre d’onglets */
    .topbar{
      background:#cfcfcf;border-bottom:1px solid #9c9c9c;
      display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;
      padding:6px 12px;
      padding-left: calc(12px + env(safe-area-inset-left, 0px));
      padding-right: calc(12px + env(safe-area-inset-right, 0px));
    }
    .tabs{display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;position:relative}
    .tabs:after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:#b5b5b5}
    .tab{background:#e9e9e9;padding:6px 10px;border-top:1px solid #fff;border-left:1px solid #fff;border-right:1px solid #8f8f8f;border-bottom:1px solid #8f8f8f;border-radius:4px 4px 0 0;font-weight:700;white-space:nowrap}
    .tab.active{background:#fff;border-bottom-color:#fff}
    .tab.active .tab-label{color:#0047cc;text-decoration:underline}
    .status{margin-left:auto;padding-bottom:6px;font-size:12px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:50%}

    /* Layout principal */
    .main { flex: 1 1 auto; min-height: 0; display: flex; gap: 10px; padding: 12px; }
    .rightcol { width:240px; display:flex; flex-direction:column; gap:10px; min-width:220px }
    .box{background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;padding:10px}
    .members .member{padding:4px 6px;border-bottom:1px dashed #ededed}

    .chat-panel {
      flex: 1 1 auto; min-height: 0;
      display: flex; flex-direction: column;
      background:#f7f7f7;border:1px solid #cfcfcf;border-radius:6px;
    }

    .header-chat{
      background:linear-gradient(#efefef,#e6e6e6);
      padding:10px;border-bottom:1px solid #d0d0d0;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding-left: calc(10px + env(safe-area-inset-left, 0px));
      padding-right: calc(10px + env(safe-area-inset-right, 0px));
    }
    .room{font-weight:bold;color:#0b4a7a}

    /* SEULE zone scrollable */
    .dialogue{
      flex: 1 1 auto; min-height: 0;
      background:#fff;
      padding:10px 12px;
      padding-left: calc(12px + env(safe-area-inset-left, 0px));
      padding-right: calc(12px + env(safe-area-inset-right, 0px));
      padding-bottom: calc(var(--inputH) + 12px);  /* <-- réserve pour la barre fixe */
      border-left:1px solid #cfcfcf;border-right:1px solid #cfcfcf;
      overflow-y:auto !important;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action: pan-y;                        /* autorise le scroll ici */
      height: 100%; max-height: 100%;
    }
    .message{margin:6px 0;line-height:1.45;font-size:14px}
    .sys{color:#8a8a8a;font-style:italic}
    .msg-pseudo{font-weight:bold;margin-right:6px}
    .pseudo-blue{color:#0044cc}.pseudo-red{color:#cc0000}.pseudo-yellow{color:#b8860b}.pseudo-green{color:#1e7d3b}

    /* BARRE D’ENTRÉE FIXE (au-dessus des toolbars/clavier) */
    .input-area{
      position: fixed;
      left: env(safe-area-inset-left, 0px);
      right: env(safe-area-inset-right, 0px);
      bottom: env(safe-area-inset-bottom, 0px);
      z-index: 50;

      display:flex;align-items:center;gap:8px;
      padding:8px 12px;
      border-top:1px solid #dcdcdc;
      background:linear-gradient(#f6f6f6,#ececec);
      touch-action: manipulation;               /* interactions normales */
    }
    .nick{width:140px;padding:8px;border:1px solid #cfcfcf;border-radius:6px;background:#fff;touch-action:auto}
    .txt{flex:1;padding:8px;border:1px solid #cfcfcf;border-radius:6px;background:#fff;touch-action:auto}
    .send{padding:8px 14px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;min-width:78px;touch-action:auto}
    .mobile-color{display:none}

    @media (max-width: 820px){
      .rightcol{display:none !important}
      .mobile-color{display:inline-block}
      .nick{width:110px}
      .input-area{gap:6px}
      .status{max-width:40%}
    }
  </style>

  <script>
    /* VisualViewport : ajuste la hauteur de l’app pour éviter toute coupe verticale,
       y compris quand le clavier s’ouvre/ferme. */
    (function(){
      const setAppH = () => {
        const vv = window.visualViewport;
        const h = vv ? vv.height : window.innerHeight;
        document.documentElement.style.setProperty('--appH', h + 'px');
      };
      setAppH();
      window.addEventListener('resize', setAppH);
      window.addEventListener('orientationchange', setAppH);
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', setAppH);
        window.visualViewport.addEventListener('scroll', setAppH);
      }
    })();

    /* Empêche tout scroll tactile hors de la zone messages */
    document.addEventListener('touchmove', (e)=>{
      if(!e.target.closest('.dialogue')) e.preventDefault();
    }, { passive:false });

    /* Mesure dynamique de la hauteur de la barre d’entrée fixe
       pour réserver la place dans .dialogue (padding-bottom). */
    window.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('form');
      if(!form) return;
      const apply = ()=>{
        const r = form.getBoundingClientRect();
        document.documentElement.style.setProperty('--inputH', r.height + 'px');
      };
      apply();
      new ResizeObserver(apply).observe(form);
      window.addEventListener('resize', apply);
    });
  </script>
</head>
<body>
  <div id="app">
    <div class="topbar">
      <div class="tabs" aria-label="Onglets">
        <div class="tab active"><span class="tab-label">Salon</span></div>
        <div class="tab"><span class="tab-label">Connecté(e)s</span></div>
        <div class="tab"><span class="tab-label">Options</span></div>
        <div class="tab"><span class="tab-label">Ami(e)s</span></div>
        <div class="tab"><span class="tab-label">Mon compte</span></div>
      </div>
      <div class="status">Connecté en tant que <strong id="meLabel">invitéabc</strong></div>
    </div>

    <main class="main">
      <aside class="rightcol">
        <div class="box">
          <h4>Membres (démo)</h4>
          <div id="roster" class="members"></div>
        </div>
        <div class="box desktop-color">
          <h4>Options rapides</h4>
          <label>Couleur pseudo
            <select id="color">
              <option value="blue">Bleu</option>
              <option value="red">Rouge</option>
              <option value="yellow">Jaune</option>
              <option value="green">Vert</option>
            </select>
          </label>
        </div>
      </aside>

      <section class="chat-panel">
        <div class="header-chat">
          <div class="room" id="roomTitle">#cafe-des-modes</div>
          <div class="topic">Bienvenue — temps réel</div>
        </div>

        <div id="dialogue" class="dialogue" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <!-- BARRE FIXE EN BAS -->
  <form id="form" class="input-area">
    <input id="nick" class="nick" placeholder="Pseudo" value="invitéabc" required />
    <select id="colorMobile" class="mobile-color" aria-label="Couleur du pseudo (mobile)">
      <option value="blue">Bleu</option>
      <option value="red">Rouge</option>
      <option value="yellow">Jaune</option>
      <option value="green">Vert</option>
    </select>
    <input id="text" class="txt" placeholder="Écris ton message..." autocomplete="off" />
    <button class="send" type="submit">Envoyer</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Paramètres nick/room
    function getInitialParams(){
      const search = new URLSearchParams(location.search);
      let nick = search.get('nick');
      let room = search.get('room');
      const hash = (location.hash || '').replace(/^#/, '');
      if(hash){
        const hp = new URLSearchParams(hash);
        nick = nick || hp.get('nick');
        room = room || hp.get('room');
        if(!room){
          const firstPart = hash.split('&')[0];
          if(firstPart) room = '#' + decodeURIComponent(firstPart.replace(/^%23/, ''));
        }
      }
      return { nick: (nick || 'invitéabc').slice(0,32), room: room || '#cafe-des-modes' };
    }
    const init = getInitialParams();

    // Éléments
    const dlg = document.getElementById('dialogue');
    const form = document.getElementById('form');
    const text = document.getElementById('text');
    const nickInput = document.getElementById('nick');
    const colorSel = document.getElementById('color');
    const colorMobile = document.getElementById('colorMobile');
    const meLabel = document.getElementById('meLabel');
    const roster = document.getElementById('roster');
    const roomTitle = document.getElementById('roomTitle');

    // Init UI
    nickInput.value = init.nick;
    meLabel.textContent = init.nick;
    roomTitle.textContent = init.room;

    function syncColor(from){
      const v = from.value;
      if(colorSel) colorSel.value = v;
      if(colorMobile) colorMobile.value = v;
    }
    if(colorSel) colorSel.addEventListener('change', e => syncColor(e.target));
    if(colorMobile) colorMobile.addEventListener('change', e => syncColor(e.target));
    if(colorSel && colorMobile){ colorMobile.value = colorSel.value; }

    // Socket
    const socket = io();
    let lastSent = null;

    function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    function line(type, pseudo, content, color){
      const div = document.createElement('div');
      div.className = 'message ' + (type==='sys'?'sys':'');
      if(type==='sys'){ div.textContent = '— ' + content; }
      else { div.innerHTML = '<span class="msg-pseudo pseudo-'+(color||'blue')+'">'+escapeHtml(pseudo)+'&gt;</span> '+escapeHtml(content); }
      dlg.appendChild(div);
      dlg.scrollTop = dlg.scrollHeight; // auto-scroll interne
    }

    function updateMe(){
      meLabel.textContent = nickInput.value || 'invitéabc';
      if(roster){
        const pseudo = nickInput.value || 'invitéabc';
        roster.innerHTML = ['caranormandie','mike-caen','guest_42', pseudo]
          .map(u => '<div class="member">'+escapeHtml(u)+'</div>').join('');
      }
    }
    nickInput.addEventListener('input', updateMe);
    updateMe();

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const txt = text.value.trim();
      if(!txt) return;
      const pseudo = nickInput.value || 'invitéabc';
      const color = (colorSel && colorSel.value) || (colorMobile && colorMobile.value) || 'blue';
      const payload = pseudo + ': ' + txt;
      lastSent = payload;
      line('msg', pseudo, txt, color);
      socket.emit('chat message', payload);
      text.value='';
      text.focus();
    });

    socket.on('chat message', (msg) => {
      if(lastSent && msg === lastSent){ lastSent = null; return; }
      const m = String(msg).split(':', 2);
      const pseudo = m[0] || 'autre';
      const content = msg.slice((pseudo+':').length).trim();
      line('msg', pseudo, content, 'red');
    });

    line('sys', '', 'Connecté(e) en tant que ' + init.nick + ' • Salon: ' + init.room + '.');
  </script>

  <script src="/caramail_nav.js"></script>
</body>
</html>
