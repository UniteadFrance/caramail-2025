<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Connecté(e)s — 3615celib</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#111}
    header{background:#cfcfcf;border-bottom:1px solid #9c9c9c;padding:10px 12px}
    main{max-width:900px;margin:0 auto;padding:12px}
    .stats{color:#666;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px}
    .room{font-weight:600;margin-bottom:6px}
    .pill{display:inline-block;margin:3px 6px 3px 0;padding:6px 10px;border-radius:16px;border:1px solid #dedede;background:#fafafa}
    .blue{color:#0044cc}.red{color:#c00}.yellow{color:#b8860b}.green{color:#1e7d3b}
    .muted{color:#888}
  </style>
</head>
<body>
  <header>
    <strong>Connecté(e)s en temps réel</strong>
    <div class="stats" id="stats">Chargement…</div>
  </header>
  <main>
    <div class="grid" id="grid"></div>
  </main>

  <script src="/socket.io/socket.io.js"></script>
<script>
  const roomsEl = document.getElementById('rooms');
  const badgeEl = document.getElementById('badge');
  const subEl   = document.getElementById('sub');

  function esc(s){return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));}
  function cssColor(c){const t=(c||'').toLowerCase();return (t==='red'||t==='green'||t==='yellow'||t==='blue')?t:'blue';}

  async function refreshPresence() {
    try {
      const r = await fetch('/presence',{cache:'no-store'});
      const data = await r.json();
      const list = Array.isArray(data.list) ? data.list : [];

      badgeEl.textContent = String(list.length);
      subEl.textContent = list.length
        ? `${list.length} connecté(e)s actuellement`
        : 'Aucun(e) connecté(e) pour le moment';

      // Grouper par salon
      const byRoom = new Map();
      for (const u of list) {
        const room = (u.room || '#general').trim();
        if (!byRoom.has(room)) byRoom.set(room, []);
        byRoom.get(room).push(u);
      }

      if (!byRoom.size) {
        roomsEl.innerHTML = `<div class="empty">Personne en ligne pour le moment.</div>`;
        return;
      }

      const html = [...byRoom.entries()]
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([room, members]) => {
          const pills = members
            .sort((a,b)=> (a.nick||'').localeCompare(b.nick||''))
            .map(u => `<a class="user ${cssColor(u.color)}" href="/caramail_dm.html?peer=${encodeURIComponent(u.nick||'invité')}">${esc(u.nick||'invité')}</a>`)
            .join('');
          return `
            <section class="room">
              <div class="room-hd">
                <span class="room-name">${esc(room)}</span>
                <span class="room-count">(${members.length})</span>
              </div>
              <div class="room-bd"><div class="users">${pills || '<span class="muted">—</span>'}</div></div>
            </section>`;
        }).join('');

      roomsEl.innerHTML = html;
    } catch (e) {
      subEl.textContent = 'Erreur de chargement…';
    }
  }

  // Premier chargement, puis toutes les 5s
  refreshPresence();
  setInterval(refreshPresence, 5000);
</script>


</body>
</html>
